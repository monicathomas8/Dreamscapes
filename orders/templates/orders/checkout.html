{% extends "base.html" %}

{% block content %}
    <h2>Checkout</h2>

    <table>
        <thead>
            <tr>
                <th>Image</th>
                <th>Title</th>
                <th>Price</th>
            </tr>
        </thead>
        <tbody>
            {% for item in cart.values %}
                <tr>
                    <td><img src="{{ item.image }}" alt="{{ item.title }}" width="100"></td>
                    <td>{{ item.title }}</td>
                    <td>£{{ item.price }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <p><strong>Total:</strong> £{{ total_price }}</p>

    <form id="payment-form">
        <div id="card-element"></div> <!-- Stripe's card input field -->
        <button type="submit" class="btn btn-success">Pay Now</button>
    </form>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        // Initialize Stripe
        var stripe = Stripe("{{ stripe_public_key }}");
        var elements = stripe.elements();

        // Create the card element
        var cardElement = elements.create("card");
        cardElement.mount("#card-element");

        // Handle form submission
        document.querySelector("#payment-form").addEventListener("submit", function(event) {
            event.preventDefault();

            stripe.confirmCardPayment("{{ client_secret }}", {
                payment_method: { card: cardElement }
            }).then(function(result) {
                if (result.error) {
                    // Display error message
                    alert(result.error.message);
                } else {
                    // Redirect to a success page
                    window.location.href = "/thank-you/";
                }
            });
        });
    </script>
{% endblock %}